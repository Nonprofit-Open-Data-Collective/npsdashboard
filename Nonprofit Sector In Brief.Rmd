---
title: "Old Code & New Outlook"
author: "Vincent Liu"
date: '2022-06-24'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = F,
                      eval = FALSE,
                      warning = FALSE)
```


```{r}
library(httr)
library(tidyverse)
library(stringr)
library(RCurl)
library(reshape2)
library(RColorBrewer)
library(extrafont)
library(knitr)
library(foreign)
library(kableExtra)
library(urbnthemes)
library(grid)
library(gridExtra)
library(rmarkdown)
library(plotly)

set_urbn_defaults()
```


```{r}
#source("NCCS_Code/Prep NCCS Core File.R")
#source("NCCS_Code/Prep IRS BMF.R")
```

```{r}
#getbmffile("2006", "01")
```

Clean and Process NCCS Core Data 
```{r}
processcorefile <- function(year, type) {
  filepath = paste0("Data/coreco.core", year, type, ".csv")

  if (type %in% c("pc", "co") ) {
    
    colspec = cols_only(EIN = col_character(),
                    OUTNCCS = col_character(),
                   SUBSECCD = col_character(),
                     FNDNCD = col_character(),
                        TOTREV = col_double(),
                          EXPS = col_double(),
                       ASS_EOY = col_double(),
                         GRREC = col_double())
    
  } else if (type == "pf") {
    
    colspec = 
            cols_only(EIN = col_character(),
                  OUTNCCS = col_character(),
                 SUBSECCD = col_character(),
                   FNDNCD = col_character(),
                    P1TOTREV = col_double(),
                    P1TOTEXP = col_double(),
                    P2TOTAST = col_double())
    
  }
  else {
    warning("Invalid file type: type must be 'co', 'pc', or 'pf'")
  }
  
  file <- read_csv(filepath, col_types = colspec)
  names(file) <- toupper(names(file))
  return(file)
}
```


```{r}
core2019co = processcorefile("2019", "co")
core2019pc = processcorefile("2019", "pc")
core2019pf = processcorefile("2019", "pf")
```


Process the Index data and Merge it with the core files
```{r}
nteedocalleins <- read_csv("Data/nteedocalleins.csv",
                           col_types = cols_only(EIN = col_character(),
                                                 NteeFinal = col_character()
                                                 )) %>% 
                rename(NTEEFINAL = NteeFinal)
```

```{r}
arts <- c("A")
highered <- c("B4", "B5")
othered <- c("B")
envanimals <- c("C", "D")
hospitals <- c('E20','E21','E22','E23','E24','F31','E30','E31','E32')
otherhlth <- c("E", "F", "G", "H")
humanserv <- c("I", "J", "K", "L", "M", "N", "O", "P")
intl <- c("Q")
pubben <- c("R", "S", "T", "U", "V", "W", "Y", "Z")
relig <- c("X")
```

```{r}
classify <- function(dataset) {
  
  dataset <- dataset %>%
    left_join(nteedocalleins, by = "EIN") 
    
  exp = dataset$EXPS
  firlet = str_sub(dataset$NTEEFINAL, 1, 1)
  fir2let = str_sub(dataset$NTEEFINAL, 1, 2)
  fir3let = str_sub(dataset$NTEEFINAL, 1, 3)
  
  dataset <- dataset %>%
    mutate(NTEEGRP = "  ") %>%
    mutate(NTEEGRP = case_when(
      firlet %in% arts ~ "Arts",
      firlet %in% othered & !(fir2let %in% highered)  ~ "Other education",
      fir2let %in% highered  ~ "Higher education",
      firlet %in% envanimals ~ "Environment and animals",
      firlet %in% otherhlth & !(fir3let %in% hospitals) ~ "Other health care",
      fir3let %in% hospitals ~ "Hospitals and primary care facilities",
      firlet %in% humanserv ~ "Human services",
      firlet %in% intl ~ "International",
      firlet %in% pubben ~ "Other public and social benefit",
      firlet %in% relig ~ "Religion related")) %>%
    mutate(NTEEGRP = if_else(is.na(NTEEFINAL), "Other public and social benefit", NTEEGRP)) %>%
    
    mutate(EXPCAT = "  ") %>%
    mutate(EXPCAT = case_when(
      exp < 100000 ~ "a. Under $100,000",
      exp >= 100000 & exp < 500000 ~ "b. $100,000 to $499,999",
      exp >= 500000 & exp < 1000000 ~ "c. $500,000 to $999,999",
      exp >= 1000000 & exp < 5000000 ~ "d. $1 million to $4.99 million",
      exp >= 5000000 & exp < 10000000 ~ "e. $5 million to $9.99 million",
      exp >= 10000000 ~ "f. $10 million or more"))
  
  return(dataset)
}
```


```{r}
core2019pc <- classify(core2019pc)
```

```{r}
# NTEE: National Taxonomy of Exempt Entities (NTEE) system

# EIN: Employer Identification Number
# ASS_EOY: Total assets at the end of year
# EXPS:Total Expenses
# FNDNCD: Reason for 501(c)(3) status (Under Other Descriptive Info): categorical/character
# GRREC: Gross Income
# OUTNCCS: Out of Scope flag: In/Out (of scope): OUT --> (see OUTREAS under Basic Info)
# SUBSECCD: Subsection code (under Classification)
# TOTREV: Total Revenue calculated
# NTEEFINAL: NTEE - final
# NTEEGRP
# EXPCAT
```

```{r}
core2019pc %>% 
  head(5)     #FNDNCD, OUTNCCS, NTEEFINAL: a lot of NAs
```

Get and clean bmf (IRS Business Master File):
```{r}
c_types <-                      cols_only( EIN = col_character(),
                                           NTEECC = col_character(),
                                           STATE = col_character(),         
                                           OUTNCCS = col_character(), 
                                           SUBSECCD = col_character(),
                                           FNDNCD = col_character(),
                                      #     CFILER = col_character(),
                                           CFINSRC = col_character(),
                                           CTAXPER = col_character(),
                                           CTOTREV = col_double(),
                                           CASSETS = col_double(),
                                           NTEEFINAL = col_character())

bmf2019 = read_csv("Data/bmf.bm1908.csv", col_types = c_types)
bmf2020 = read_csv("Data/bmf.bm2004.csv", col_types = c_types)
bmf2022 = read_csv("Data/bmf.bm2201.csv", col_types = c_types)
```

```{r}
inflindex <- read_csv("External_Data/Inflation Index.csv", col_types = "cd", col_names = c("Year", "CPI")) %>%
  filter(!row_number() == 1L)
#a <- read.csv("External_Data/Inflation Index.csv", row.names =1, header = TRUE)
```

Move to next phase of cleaning 

```{r}


bmfsize <- function(data, year) {

      t1 <- data %>% 
        filter((OUTNCCS != "OUT")) %>%
        summarize(
          Year = as.character(year),
          "All registered nonprofits" = n())
      
      t2 <- data %>% 
        filter((FNDNCD != "02" & FNDNCD!= "03" & FNDNCD != "04"), (SUBSECCD == "03"|SUBSECCD== "3"), (OUTNCCS != "OUT")) %>%
        summarize(
          Year = as.character(year),
          "501(c)(3) public charities" = n()
        )
      
    combined <- t1 %>%
      left_join(t2, by = "Year")
  
    return(combined)
}

b1 <- bmfsize(bmf2019, 2019)
b2 <- bmfsize(bmf2020, 2020)
b3 <- bmfsize(bmf2022, 2022)
t <- bind_rows(b1,b2,b3)
```

```{r}
p1 <- t %>%
#  gather(stat, value, `All registered nonprofits`, `501(c)(3) public charities`) %>%
#  ggplot(aes(x = as.factor(Year), y = value, color = stat, group=1)) +
  ggplot(aes(x = as.factor(Year), group=1)) +
  geom_line(aes(y = `All registered nonprofits`, color = "blue")) +
  geom_point(aes(y = `All registered nonprofits`, color = "blue")) +
  geom_line(aes(y = `501(c)(3) public charities`, color = "red")) +
  geom_point(aes(y = `501(c)(3) public charities`, color = "red")) +
  ggtitle("Total Nonprofit Counts by Year", subtitle = "From 2019 to 2022") +
  labs(x = "Year", y = " ") +
   guides(color = guide_legend(title = " ")) +
  scale_color_discrete(labels = c("All registered nonprofits", "501(c)(3) public charities")) +
   geom_text(aes(as.factor(Year),`All registered nonprofits` , label= `All registered nonprofits`),
              vjust= -1, 
              position = position_dodge(width=1),
              size =3) +
   geom_text(aes(as.factor(Year),`501(c)(3) public charities` , label= `501(c)(3) public charities`),
              vjust=-1, 
              position = position_dodge(width=1),
              size =3) +
   ylim(NA, 1550000)

p1
# ggplotly(p1)
```

```{r}
corefiles <- function(data, dyear, dtype) {
  
  if (dtype == "pc") {
  processed <- if(dyear < 2010) filter(data, (GRREC >= 25000)) else filter(data, ((GRREC >= 50000)|(TOTREV>50000))) %>%
      filter((is.na(OUTNCCS)|OUTNCCS != "OUT"), (FNDNCD != "02" & FNDNCD!= "03" & FNDNCD != "04")) %>%
      summarize(
        Reporting = n(),
        "Revenue ($ billions)" = round((sum(as.numeric(TOTREV), na.rm =TRUE))/1000000000, digits =2),
        "Expenses ($ billions)" = round((sum(as.numeric(EXPS), na.rm =TRUE))/1000000000, digits =2),
        "Assets ($ billions)" = round((sum(as.numeric(ASS_EOY), na.rm =TRUE))/1000000000, digits=2))
    processed <- melt(processed)
    colnames(processed)[2] <- "PC"
  
  } elif (dtype == "co") {
  processed <- if(dyear < 2010) filter(data, ((GRREC >= 25000)|(TOTREV>25000))) else filter(data, ((GRREC >= 50000)|(TOTREV>50000))) %>%
      filter((OUTNCCS != "OUT")) %>%
      summarize(
        Reporting = n(),
        "Revenue ($ billions)" = round((sum(as.numeric(TOTREV), na.rm =TRUE))/1000000000, digits =2),
        "Expenses ($ billions)" = round((sum(as.numeric(EXPS), na.rm =TRUE))/1000000000, digits =2),
        "Assets ($ billions)" = round((sum(as.numeric(ASS_EOY), na.rm =TRUE))/1000000000, digits=2))
    processed <- melt(processed)
    colnames(processed)[2] <- "CO"
  
  } elif (dtype == "pf") {
    processed <- data %>%
      filter(OUTNCCS != "OUT") %>%
      summarize(
        Reporting = n(),
        "Revenue ($ billions)" = round((sum(as.numeric(P1TOTREV), na.rm =TRUE))/1000000000, digits =2),
        "Expenses ($ billions)" = round((sum(as.numeric(P1TOTEXP), na.rm =TRUE))/1000000000, digits =2),
        "Assets ($ billions)" = round((sum(as.numeric(P2TOTAST), na.rm =TRUE))/1000000000, digits=2))
    processed <- melt(processed)
    colnames(processed)[2] <- "PF"
  }
} 

```




