---
title: "Nonprofit Sector In Brief Dashboard"
date: "`r lubridate::today()`"
output: 
  flexdashboard::flex_dashboard:
    social: menu
    source_code: embed
    theme: cosmo
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE, 
                      warning =FALSE)
```

```{r, include=FALSE}
library(flexdashboard)
library(htmlwidgets)
library(DT)

library(httr)
library(tidyverse)
library(stringr)
library(RCurl)
library(reshape2)
library(RColorBrewer)
library(extrafont)
library(knitr)
library(foreign)
library(kableExtra)
library(urbnthemes)
library(grid)
library(gridExtra)
library(rmarkdown)
library(plotly)

set_urbn_defaults()
```



Summary {.storyboard}
=======================================================================

```{r, echo=F}
Nonprofit_trend <- read_csv("Data/Output_Data/Number_nonprofit_trend.csv") %>%
  select(!1)
Nonprofit_trend$Year = as.character(Nonprofit_trend$Year)
#datatable(Nonprofit_trend, style = "auto",  options = list(pageLength = 5))
```

### 501 C(3) Nonprofits in a Decade
```{r}
p_trend <- Nonprofit_trend %>%
  ggplot(aes(x = as.factor(Year), group=1)) +
  geom_line(aes(y = `All registered nonprofits`), color = "#00CCFF") +
  geom_point(aes(y = `All registered nonprofits`), color = "#00CCFF", size = .8) +
  geom_line(aes(y = `501(c)(3) public charities`), color = "#99FF33") +
  geom_point(aes(y = `501(c)(3) public charities`), color = "#99FF33", size = .8) +
  geom_line(aes(y = `501(c)(3) private foundations`), color = "#FF9933") +
  geom_point(aes(y = `501(c)(3) private foundations`), color = "#FF9933", size = .8) +
  ggtitle("A Tend in Number of 501c(3) Nonprofit", subtitle = "From 2002 to 2022") +
  labs(x = "Year", y = " ") +
   guides(color = guide_legend(title = " ")) +
  scale_color_discrete(labels = c("All registered nonprofits", "501(c)(3) public charities")) +
   geom_text(aes(as.factor(Year),`All registered nonprofits` , label= `All registered nonprofits`),
              vjust= -1, 
              position = position_dodge(width=1),
              size =3) +
   geom_text(aes(as.factor(Year),`501(c)(3) public charities` , label= `501(c)(3) public charities`),
              vjust=-1, 
              position = position_dodge(width=1),
              size =3) +
    geom_text(aes(as.factor(Year),`501(c)(3) private foundations` , label= `501(c)(3) private foundations`),
              vjust=-1, 
              position = position_dodge(width=1),
              size =3) +
   ylim(NA, 1600000) +
   theme(legend.position="right", legend.direction = "vertical")

p_trend <- p_trend + annotate("text", x = 4.2, y = 1300000, label = "All nonprofit", size = 3.5)
p_trend <- p_trend + annotate("text", x = 4.2, y = 1000000, label = "Public charity", size = 3.5)
p_trend <- p_trend + annotate("text", x = 4.2, y = 150000, label = "Private foundation", size = 3.5)


ggplotly(p_trend)
```

***

- The number of registered nonprofits reached its highest point in 2017 but have been decreasing since then. 
- 501 c(3) Public charities counted for a great percentage of all nonprofits 
- Private foundations changed at a lower magnitude compared to private foundations
- The nonprofit sector is heavily impacted by the domestic economic market


$\textbf{Source:}$ IRS Business Master File 2002, 2012, 2017, 2022


### Financial Information by Type

```{r}
Finance <- read_csv("Data/Output_Data/Nonprofit_finance_2019.csv") %>%
  select(!1)
p_fin <- Finance %>%
  filter(Type  %in% c("PC", "CO", "PF"), Variable != "Reporting") %>%
  ggplot(aes(x = Variable, y = Value, fill = Type)) +
  geom_col(position = "dodge") +
  geom_text(aes(Variable, Value, label=Value),
              vjust=-1.1, 
              position = position_dodge(width=1),
              size =3.2) +
  ylim(NA, 5000) +
   theme(legend.position="right", legend.direction = "vertical")

ggplotly(p_fin)
```

***

- In the year of 2019, public charities had the most assets, spend the most, and returned the most revenues among all nonprofits. 
- All nonprofits, on average, were profitable this year, calculated as $\text{Revenue - Expense}$.
- Private foundations were more profitable than public charities, considering private foundations represented a much smaller share than public foundations, whereas, the gaps in expense and revenues (PF is 4ish times smaller than PC) are not as great as the size differences (PF is 10 times smaller than PC)


Source: NCCS Core File 2019



Public Charity in 2019 {.storyboard}
=======================================================================

### Perspective - In or Outside the NCCS Scope
 
```{r, echp =F}
pc2019 <- read_csv("Data/Output_Data/new_core2019pc.csv") %>% select(!1)
```

```{r}
p_inout <- pc2019 %>% filter(OUTNCCS %in% c("IN", "OUT")) %>% group_by(OUTNCCS) %>% 
  summarise(Number = n()) %>%
  ggplot(aes(x = OUTNCCS, y = Number)) +
  geom_col() +
  labs(x = NULL, 
          y = NULL) +
  geom_text(aes(label = Number), position = position_dodge(width = 0.7), vjust = -1, size = 6) +  
  theme(
#  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.ticks = element_blank())

ggplotly(p_inout)
```

***

- Of 390249 nonprofits, 1198 or 0.31% is outside the NCCS scope. This is a tiny percentage. 
- The NCCS categorized those out-of-nccs nonprofits into 7 groups in total based on reasons. These 7 groups could be accessed at the `OUTREAS` item on (https://nccs-data.urban.org/dd2.php?close=1&form=Core+2013+PC)

### Perspective - In or Outside the NCCS Scope

```{r}

pc2019_out <- pc2019 %>% filter(OUTNCCS %in% c("OUT")) %>% group_by(OUTNCCS, NTEEGRP) %>% summarise(Number = n()) %>% mutate(NTEEGRP = factor(NTEEGRP)) 
#pc2019_out <- pc2019_out[c(11, 1:2, 3, 7, 4, 8, 5, 9:10, 6),]

p_outnccs <- pc2019_out %>%
   filter(is.na(NTEEGRP)==F, NTEEGRP != "Human services") %>% 
   ggplot(aes(x = Number, y = reorder(NTEEGRP, Number))) +
   geom_point() +
     scale_x_continuous(expand = c(0,0), limits = c(40, 220)) +
  labs(x = NULL, 
          y = NULL) +
   geom_segment(aes(x = 0, xend = Number, y = NTEEGRP, yend = NTEEGRP)) + 
 #  scale_y_discrete(limits = rev) +
   ggtitle("Public Charities Outside the NCCS Scope in 2019", subtitle = "by NTEE groups in 2019") 

#  ggalt::geom_lollipop(point.colour = "steelblue", point.size = 2, horizontal = T) +

ggplotly(p_outnccs)
```

***

The top four NTEE groups that have out-of-scope nonprofits are:

* Other public and social benefits
* Other education
* Other healthcare
* Arts


### Perspective - Expense Level
```{r}
PC_expense <- read_csv("Data/Output_Data/PC2019_by_expense.csv") %>%
  select(!1)

PC_expense_long <- PC_expense  %>%
  pivot_longer(4:7, values_to = "Value", names_to = "Financial_Group") 

p_expense <- PC_expense_long %>%
  filter(Financial_Group %in% c("Total Expenses", "Gross Income")) %>%
  ggplot(aes(x = `Expense Group`, y = Value, fill = Financial_Group)) +
  geom_col(position = "dodge") + 
  coord_flip() +
  labs(x = NULL, 
       y = NULL)
p_expense
```

***




### Perspective - Category Group
```{r}
PC_category <- read_csv("Data/Output_Data/PC2019_by_category.csv") %>%
  select(!1)

PC_category_long <- PC_category %>%
  pivot_longer(4:7, values_to = "Value", names_to = "NTEE_Group") %>%
 filter(NTEE_Group %in% c("Total Expenses", "Gross Income")) %>%
  select(Category, NTEE_Group, Value)


p_category <- PC_category_long %>%
  ggplot(aes(x = Category, y = Value, fill = NTEE_Group)) +
  geom_col(position = "dodge") + 
  coord_flip() +
  labs(x = NULL, 
       y = NULL) 
  #scale_y_discrete(limits = rev)

p_category
#ggplotly(p_category)
```

***

- Education and Healthcare are two big parts!





Private Foundation {.storyboard}
=======================================================================

### Inline Shiny App via shinyApp

Some words

```{r, include=F}
# shinyApp(
#   ui = fillPage(
#     fillCol(flex = c(NA, 1), 
#       inputPanel(
#         selectInput("region", "Region:", choices = colnames(WorldPhones))
#       ),
#       plotOutput("phonePlot", height = "100%")
#     )
#   ),
#   server = function(input, output) {
#     output$phonePlot <- renderPlot({
#       barplot(WorldPhones[,input$region]*1000, 
#               ylab = "Number of Telephones", xlab = "Year")
#     })
#   },
#   options = list(height = 600)
# )
```





Geography
=======================================================================

Column {data-height=400}
-----------------------------------------------------------------------
### External Shiny App via shinyAppDir

Column {data-height=400}
-----------------------------------------------------------------------
### External Shiny App via shinyAppDir

Some words

```{r}
# shinyAppDir(
#   system.file("examples/06_tabsets", package="shiny"),
#   options = list(height=850)
# )
```

